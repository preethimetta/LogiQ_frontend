<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LogiQ â€“ Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: Inter, Arial, sans-serif; }
    #map { height: 100%; width: 100%; }
    .eta {
      position: absolute; bottom: 20px; left: 20px; z-index: 1000;
      background: #fff; padding: 12px; border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.2);
      width: 260px;
    }
    .eta p { margin: 6px 0; font-weight: 600; }
    .traffic { color: #ef4444; }
    .classical { color: #10b981; }
    .quantum { color: #7c3aed; }
    .tolls { color: #f59e0b; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="eta">
    <h3>â± ETA</h3>
    <p id="eta-traffic" class="traffic">ğŸš¦ Traffic: â€”</p>
    <p id="eta-classical" class="classical">âœ… Classical: â€”</p>
    <p id="eta-quantum" class="quantum">âš› Quantum: â€”</p>
    <p id="eta-tolls" class="tolls">ğŸ’° Tolls: â€”</p>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ---------- URL parameters ----------
    const params = new URLSearchParams(window.location.search);
    const vehicle = params.get("vehicle");
    const cc = params.get("cc");
    const dest = params.get("dest");

    if (!vehicle || !cc || !dest) {
      alert("Missing parameters from fleet.html");
      throw new Error("Missing parameters");
    }

    // ---------- Map ----------
    const map = L.map("map").setView([20, 78], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap"
    }).addTo(map);

    let start = null;
    let destMarker = null;
    let routeLayers = [];
    let tollMarkers = [];

    const tollIcon = L.icon({
      iconUrl: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -28]
    });

    // ---------- Reverse Geocode ----------
    async function reverseGeocode(lat, lng) {
      try {
        // Option 1: call your backend if you have one
        // const res = await fetch(`http://127.0.0.1:8000/reverse_geocode?lat=${lat}&lng=${lng}`);
        // const data = await res.json();
        // return data.name || data.display_name || "Unknown place";

        // Option 2: query OpenStreetMap directly
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`;
        const res = await fetch(url, { headers: { "User-Agent": "logiq-app" } });
        const data = await res.json();
        return data.display_name || "Unknown place";
      } catch (err) {
        console.error("Reverse geocode failed:", err);
        return "Unknown place";
      }
    }

    // ---------- ETA helpers ----------
    function clearETAs() {
      document.getElementById("eta-traffic").textContent = "ğŸš¦ Traffic: â€”";
      document.getElementById("eta-classical").textContent = "âœ… Classical: â€”";
      document.getElementById("eta-quantum").textContent = "âš› Quantum: â€”";
      document.getElementById("eta-tolls").textContent = "ğŸ’° Tolls: â€”";
    }

    function removeRoutes() {
      routeLayers.forEach(l => map.removeLayer(l));
      routeLayers = [];
      tollMarkers.forEach(m => map.removeLayer(m));
      tollMarkers = [];
    }

    function drawRoute(coords, color) {
      const weight = color === "#7c3aed" ? 8 : 5;
      const poly = L.polyline(coords, { color, weight, opacity: 0.9 }).addTo(map);
      routeLayers.push(poly);
    }

    // ---------- Routes + Tolls ----------
    async function computeRoutes(end) {
      clearETAs();
      removeRoutes();
      try {
        const res = await fetch("http://127.0.0.1:8000/routes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ start, end, vehicle, cc })
        });
        const data = await res.json();

        if (data.traffic) {
          drawRoute(data.traffic.polyline, "#ef4444");
          document.getElementById("eta-traffic").textContent = `ğŸš¦ Traffic: ${data.traffic.eta}`;
        }
        if (data.classical) {
          drawRoute(data.classical.polyline, "#10b981");
          document.getElementById("eta-classical").textContent = `âœ… Classical: ${data.classical.eta}`;
        }
        if (data.quantum) {
          drawRoute(data.quantum.polyline, "#7c3aed");
          document.getElementById("eta-quantum").textContent = `âš› Quantum: ${data.quantum.eta}`;
        }

        if (data.tolls) {
          for (const t of data.tolls) {
            const addr = t.place || await reverseGeocode(t.lat, t.lng);
            const marker = L.marker([t.lat, t.lng], { icon: tollIcon })
              .addTo(map)
              .bindPopup(`ğŸ’° Toll: ${addr}<br>Cost: â‚¹${t.cost}`);
            tollMarkers.push(marker);
          }
          const total = data.tolls.reduce((a, b) => a + b.cost, 0);
          document.getElementById("eta-tolls").textContent =
            `ğŸ’° Tolls: ${data.tolls.length} | â‚¹${total}`;
        }
      } catch (err) {
        console.error("Route computation failed:", err);
      }
    }

    // ---------- Destination ----------
    async function geocodeAndCompute() {
      try {
        const geoRes = await fetch(`http://127.0.0.1:8000/geocode?query=${encodeURIComponent(dest)}`);
        const geoData = await geoRes.json();
        const lat = geoData.lat || 17.6868;
        const lng = geoData.lng || 83.2185;
        const end = L.latLng(lat, lng);

        const place = await reverseGeocode(end.lat, end.lng);
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker(end).addTo(map).bindPopup(`ğŸ¯ Destination:<br>${place}`).openPopup();

        computeRoutes(end);
      } catch (err) {
        console.warn("Destination not found, using Vizag.", err);
        const end = L.latLng(17.6868, 83.2185);
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker(end).addTo(map).bindPopup("ğŸ¯ Default Destination: Vizag").openPopup();
        computeRoutes(end);
      }
    }

    // ---------- Get current position ----------
    async function initStart() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported, using default start.");
        start = L.latLng(17.6868, 83.2185);
        const place = await reverseGeocode(start.lat, start.lng);
        L.marker(start).addTo(map).bindPopup(`ğŸ“ Start:<br>${place}`).openPopup();
        geocodeAndCompute();
        return;
      }

      navigator.geolocation.getCurrentPosition(async pos => {
        start = L.latLng(pos.coords.latitude, pos.coords.longitude);
        const place = await reverseGeocode(start.lat, start.lng);
        L.marker(start).addTo(map).bindPopup(`ğŸšš You are at:<br>${place}`).openPopup();
        geocodeAndCompute();
      }, async err => {
        console.warn("Location error:", err);
        alert("Could not get your location, using default (Vizag).");
        start = L.latLng(17.6868, 83.2185);
        const place = await reverseGeocode(start.lat, start.lng);
        L.marker(start).addTo(map).bindPopup(`ğŸ“ Start:<br>${place}`).openPopup();
        geocodeAndCompute();
      }, { enableHighAccuracy: true, timeout: 8000 });
    }

    initStart();
  </script>
</body>
</html>
